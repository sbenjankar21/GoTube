

<style>

    /* body {
        animation: fadeInAnimation ease 3s;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
    }
    @keyframes fadeInAnimation {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }
     */
    
    #overview-container
    {    animation: fadeInAnimation ease 3s;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
    
       background-color: rgb(54, 54, 54); /*ignore */
       display:flex
    
       
    }
    
    @keyframes fadeInAnimation {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }
    .video-div
    {
      /* float: left; */
      padding-left: 90px;
      padding-top: 50px;
      width: 20%;
    }
    .reviews-div
    {
      /* float: left; */
       /* display: flex;  */
      flex-grow: 1;
      justify-content: center;
    }
    
    .review-item-page
        {
    
          /* margin: auto; */
          margin: 25px auto 0px auto;
          display:block; 
          width: 75%;
          height: 270px;
          padding: 10px;
          background-color: rgb(10, 10, 10);
          /* margin-top: 10px; */
          /* transition: background-color 0.2s; */
          transition: transform 0.2s;
        }
    
    
    
     
       .review-item-page:hover
        {
          transform: scale(1.1);
          /* background-color: rgb(0, 90, 0); */
    
        }
    
    
    
    
    
    
    
        .review-username
        {
          font-size: 20px;
          float: left;
          margin-top: 10px;
          text-decoration: none;
          color: white;
        }
    
        .review-profile-image
        {
          border-radius: 50%;
          float: left;
          margin-left: 30px;
          margin-right: 15px;
          width: 50px;
        }
        .name-profile-holder
        {
          margin-top: 20px;
          width: 100%;
          height: 55px;
        }
    
        .star-containera
        {
          padding-left: 25px;
        }
        .star-one{
          /* float: left; */
        }
        .review-content
        {
          margin-left: 30px;
        }
    
        .average-stars-container
        {
          /* display: inline; */
          display: flex;
          height: 50px;
          
        }
    
        .average-star-amount
        {
          margin-right: 10px;
          color: white;
        }
        .average-star-total
        {
          margin-left: 10px;
          color: white;
        }
    
        .star-svg
        {
    
        }
        .favorite-song-holder
        {
          margin: 0px auto 0px auto;
          display: flex;
          justify-content: center;
          margin-bottom: 50px;
          width: 80%;
        }
    
        .favorite-movie-holder
        {
          margin: 0px auto 0px auto;
          display: flex;
          justify-content: center;
          margin-bottom: 50px;
          width: 80%;
        }
    
        .favorite-video-holder
        {
          margin: 0px auto 0px auto;
          display: flex;
          justify-content: center;
          margin-bottom: 50px;
          width: 80%;
        }
    
    
        /* .favorite-song-item
        {
          margin: auto auto;
          background-color: rgb(176, 72, 128);
        } */
    
    
        .favorite-song-item
        {
          margin: auto auto;
          width: 200px;
          height: 270px;
          padding: 10px;
          background-color: rgb(10, 10, 10);
          display:inline-block;
          transition: transform 0.2s;
        }
    
        .favorite-movie-item
        {
          margin: auto auto;
          width: 200px;
     
          padding: 10px;
          background-color: rgb(10, 10, 10);
          display:inline-block;
          transition: transform 0.2s;
        }
    
    
          .favorite-song-item:hover
          {
            transform: scale(1.1);
          }
    
          /* .song-img
        {
          display: inline-block;
          position: relative;
          margin-top: 10px;
        }
    
        .vInfo
        {
          height: 5px;
          margin-top: 10px;
          margin-bottom:  10px;
          font-size: 15px;
          color: rgb(245, 245, 245);
    
        } */

        .account-setting
        {
            display: flex;
            flex-direction: column; 
            width: 20%;
        }
        .favorite-setting
        {
            
            width: 80%;
        }
        .all-settings
        {
            display: flex;
        }

        .favorite-video-holder
    {
      margin: 0px auto 0px auto;
      display: flex;
      justify-content: center;
      margin-bottom: 50px;
      width: 80%;
    }


    /* .favorite-song-item
    {
      margin: auto auto;
      background-color: rgb(176, 72, 128);
    } */


    .favorite-song-item
    {
      margin: auto auto;
      width: 200px;
      height: 270px;
      padding: 10px;
      background-color: rgb(10, 10, 10);
      display:inline-block;
      transition: transform 0.2s;
    }

    .favorite-song-null
    {
      margin: auto auto;
      width: 200px;
      height: 270px;
      padding: 10px;
      background-color: rgb(10, 10, 10);
      display:inline-block;
      transition: transform 0.2s;
      cursor: pointer;
    }

    #pop-up {position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    height: 80%;
    background-color: rgba(0, 0, 0, 0.85);
    display: none;
}

#sub-div
    {
        /* margin: auto; */
        display: flex;
        /* background-color: black;
        width: 1000px;
        height: 350px; */
       /* align-items: center; */
       flex-direction: column;
       margin-top: 50px;
       
    }
    .form-container
    {
        display: flex;
  
  height: 100%; 
    }

    .search-holder
    {
        width: fit-content;
        margin: 0px auto 0px auto;
    }

    #results-div
    {
        width: 60%;
        height: 600px;
        overflow-y:auto;
         margin: 0px auto 0px auto 
    }
    .song-item-result:hover
    {
        background-color: rgb(83, 83, 83);
    }
    </style>
<script>
//  var testJson = [{name: "forn"},{name: "ggg"},null]

// for(var i = 0; i < testJson.length; i++)
// {
//   console.log(JSON.stringify(testJson[i]))
//    testJson[i] = JSON.stringify(testJson[i])
// }

//  var string = testJson.toString()
//  console.log(string)
//  console.log(string.split(","))

//  var backToArray = string.split(",")

//  console.log(JSON.parse(backToArray[2]))

function convertJsons(jsonARRAY)
{

  console.log("WTFFFF" + jsonARRAY.length)
  for(var i = 0; i < jsonARRAY.length; i++)
  {
    jsonARRAY[i] = JSON.stringify(jsonARRAY[i])
  }
  console.log("WTFFFF" + jsonARRAY.length)
  return jsonARRAY
}

function customToString(array)
{
  console.log("in here" + array.length)
  var temp = ""
  for(var i = 0; i < array.length; i++)
  {

    temp = temp.concat(array[i])
    if(i != array.length-1)
    {
    temp = temp.concat("SHRAWAN")
    }
    console.log("HELLO?")
    console.log(temp)
    console.log("goodBYE")
  }

  return temp;
}


  var tempToken = "<%=token%>";
  var songHolderChosen = -1;
  var songsToSend = [null, null, null, null,null]
  function searcb(id)
  {
    songHolderChosen = id
    var popUp = document.getElementById("pop-up");
    popUp.style.display = "block";
  }

  
async function chooseSong(id, results)
{
  var song = results.tracks.items[id]
  
  var songJson = {title: song.name, id: song.id, artist: song.artists[0].name, imageAddress: song.album.images[0].url,}




  songsToSend[parseInt(songHolderChosen)] = songJson;
  console.log(songsToSend)

  var popUp = document.getElementById("pop-up");
  popUp.style.display = "none";

  var holder = document.getElementById(songHolderChosen.toString())
  var newImage = document.createElement("img")
  newImage.className = "song-img"
  newImage.style.width = "200px"
  newImage.src = song.album.images[0].url
  holder.appendChild(newImage)


  var title = document.createElement("p")
  title.innerHTML = song.name
  title.className = "vInfo"
  holder.appendChild(title)

  var artist = document.createElement("p")
  artist.innerHTML = song.artists[0].name
  artist.style.margin = "5px 0px 0px 0px"
holder.appendChild(artist)

var hiddenInput = document.getElementById("myHidden")


var convertedJsons = convertJsons(songsToSend)

//var arrayString = convertedJsons.toString()
var arrayString = customToString(convertedJsons)


hiddenInput.value = arrayString;
console.log(hiddenInput.value)
//hiddenInput.value = JSON.stringify(song)
  // <div class ="wrapper">
  //         <p class = "vInfo" id = "overflo"



  // <img class = "song-img" src="https://i.scdn.co/image/ab67616d0000b27326f7f19c7f0381e56156c94a" alt="Lamp" width="200px">
  // <p class = "vInfo" id = "overflo"> <span style ="font-size: 20px; ">Flashing Lights</span><br> <span style="font-size: 12.5px; color:rgb(170, 170, 170)">Tyler, The Creator</span></p>

//   var containerDiv = document.getElementById("sub-div")
//   containerDiv.replaceChildren()

//   var anotherDiv = document.createElement('div')
//   containerDiv.appendChild(anotherDiv)


//   var thisLink = document.getElementById("enter-link")
//  // console.log(vid)
//   //<iframe width="560" height="315" src="https://www.youtube.com/embed/?si=zFv2_59A4Zgvz29U&autoplay=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
//   var songImage = document.createElement("img")
//       songImage.src = song.album.images[0].url
//       songImage.style.height = "200px"
//       songImage.style.width = "200px"
//       anotherDiv.appendChild(songImage)
//   // newIframe.src = "https://www.youtube.com/embed/"+getSecondPart(vid)+"?si=zFv2_59A4Zgvz29U&autoplay=1"
//   // newIframe.width = "560"
//   // newIframe.height ="315"
//   // newIframe.frameborder = "0"
//   // newIframe.allowFullscreen = true
//   // newIframe.style.display = "inline-block"
//   // containerDiv.appendChild(newIframe)


//   var formDiv = document.createElement('div')
//   formDiv.style.display = "inline-block"

//   formDiv.style.height = "100%"
//   formDiv.style.marginLeft = "20px"
//   anotherDiv.appendChild(formDiv)

//   var starDiv = document.createElement('div')
//   starDiv.style.textAlign = "center"
//   formDiv.append(starDiv)

//   var star1 = document.createElement('img')
//   star1.src = "/empty.svg"
//   star1.style.width = "50px"
//   star1.className = "star"
//   starDiv.append(star1)
//   star1.onclick = function() {gfg(1)}

//   var star2 = document.createElement('img')
//   star2.src = "/empty.svg"
//   star2.style.width = "50px"
//   star2.className = "star"
//   starDiv.append(star2)
//   star2.onclick = function() {gfg(2)}


//   var star3 = document.createElement('img')
//   star3.src = "/empty.svg"
//   star3.style.width = "50px"
//   star3.className = "star"
//   starDiv.append(star3)
//   star3.onclick = function() {gfg(3)}
  
//   var star4 = document.createElement('img')
//   star4.src = "/empty.svg"
//   star4.style.width = "50px"
//   star4.className = "star"
//   starDiv.append(star4)
//   star4.onclick = function() {gfg(4)}


//   var star5 = document.createElement('img')
//   star5.src = "/empty.svg"
//   star5.style.width = "50px"
//   star5.className = "star"
//   starDiv.append(star5)
//   star5.onclick = function() {gfg(5)}

//   var newTA = document.createElement("textarea")
//   formDiv.append(newTA)
//   newTA.classList.add("textA")
//   newTA.name = "content"
//   newTA.rows = "7"
//   newTA.cols = "50"
//   newTA.id = "text-area"
//   newTA.style.marginTop = "20px"


//   var hiddenInput = document.createElement("input")
//   hiddenInput.type = "hidden"
//   hiddenInput.id = "hidden-data"
//   formDiv.append(hiddenInput)

//   var newButton = document.createElement("button")
//   newButton.style.display = "block"
//   newButton.style.width = "100px"
//   newButton.style.height = "50px"
//   newButton.innerHTML = "Create"
//   formDiv.append(newButton)

//   newButton.onclick = function() {sendData(song)}



}
async function updateToken()
{
  try{
    //make post request to SPOTIFY API for access token, sending relavent info
    const token_url = 'https://accounts.spotify.com/api/token';
    //const data = qs.stringify({'grant_type':'client_credentials'});
    data = "grant_type=client_credentials&client_id=dc276981aa7543689c8bbd74979846ce&client_secret=c058d32f7ada4598926d803f3024ce95"

    const response = await fetch(token_url, {
      method: 'post',
      headers: {
          'Content-Type': 'application/x-www-form-urlencoded' 
      },
      body: data
    });

  //   const response = await axios.post(token_url, data, {
  //     headers: { 
  //       'Content-Type': 'application/x-www-form-urlencoded' 
  //     }
  //   })
    //return access token
    console.log("HEEEEEEEEEEEEERE")
    var resJson = await response.json()
    console.log(resJson.access_token)


    try{
      await fetch("/settings/update-token", {
          method: "POST",
          headers: {
                    'Accept': 'application/json',
      'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              newToken: resJson.access_token
      })
      })
    }
    catch(e)
    {
      console.log(e)
    }

    return await response.body.access_token;
    //consawole.log(response.data.access_token);   
  }


  catch(error){
    //on fail, log the error in console
    console.log("BROKe")
    console.log(error);
  }
}
  async function sendRequest(value)
  {
      console.log("change")
      // try{

      // console.log(value)
      // const response = await fetch("/songs/search?title="+value, {method: "GET"})
      // const songs = await response.json()
      // //console.log(songs.info)
      // return response
      // }
      // catch(e){
      //     console.log(e)
      // }
      var songResults
      if(value != "")
      {

      try{

              if(value != "")
              {
      console.log("search: " + value)


  //     const response = await fetch('https://api.spotify.com/v1/search?q=n&type=track', {
  //     method: 'GET',
  //     headers: {
  //         "Authorization": 'Bearer BQBw6wscbn5otWn_zZgZd_GNVu2Vji4wDiyDl8_ed7CJ-jjXvF9-7rai54Ox57VGieZbn4yo8M02jjZ1nYuDug4QQMr98Qcy4Og3NbZL1lIGAJfbbiA'
  //     }
  //   });

                  console.log("trying")
    const response = await fetch('https://api.spotify.com/v1/search?q='+value+'&type=track', {
      method: 'GET',
      headers: {
          "Authorization": 'Bearer '+ tempToken
      }
    });

    if(!response.ok)
    {
      throw new Error('Something went wrong');
    }
    songResults = await response.json()
    //console.log(songResults.tracks)
  }
  }

  catch(e){
      console.log("going through here")
console.log(e)
const newKey = await updateToken()
console.log("top")
console.log(newKey)
console.log("bottom")
const response = await fetch('https://api.spotify.com/v1/search?q='+value+'&type=track', {
      method: 'GET',
      headers: {
          "Authorization": 'Bearer ' + newKey
      }
    });

    songResults = await response.json()
    console.log(songResults)

  }



  try{
  //var newDiv = document.createElement("div")
  var resultDiv = document.getElementById("results-div")
  //resultDiv.remove()
  //newDiv.id = "results"

  var newChildren = []
  var tempDiv = document.createElement('div')
  resultDiv.replaceChildren()
  var songId = 0;
  songResults.tracks.items.forEach(song => {

      var songDiv = document.createElement("div")
      songDiv.style.width = "100%"
      songDiv.style.height = "100px"


      var songImage = document.createElement("img")
      songImage.src = song.album.images[0].url
      songImage.style.height = "100px"
      songImage.style.width = "100px"
      songImage.style.float = "left"

      songDiv.appendChild(songImage)

      var titleP = document.createElement("p")
      titleP.innerHTML = song.name
      titleP.style.color = "rgb(255,255, 255)"
      var artistP = document.createElement("p")
      artistP.innerHTML = song.artists[0].name

      var infoDiv = document.createElement("div")
      infoDiv.appendChild(titleP)
      infoDiv.appendChild(artistP)
      infoDiv.style.margin= " auto 0px auto 20px "

  //     position:relative;
  // top:-2px;
      // infoDiv.style.position = "relative"
      // infoDiv.style.top = "-2px"
      //infoDiv.style.display = "inline-block"
      //infoDiv.style.marginTop = "-50px"
      infoDiv.style.float = "left"

      songDiv.append(infoDiv)
      songDiv.classList.add("song-item-result")
      songDiv.id = songId.toString();
      resultDiv.append(songDiv)

      songDiv.onclick = function() {chooseSong(this.id, songResults)}
      songId++
  })

  //document.body.appendChild(newDiv)
  //console.log(tempDiv.children)
  //resultDiv.children = tempDiv.children
  }
  catch(e)
  {
      console.log(e)
  }
      }


  }
</script>
    <form class = "all-settings" action="/settings" method="post">
  <div class="account-setting">
  <h1> Account Settings</h1>

 

    <label>Username</label>
    <br>
    <input type="text" value="<%= user.username %>">
    <br>
    <br>
    <label>Email</label>
    <br>
    <input type="text" value="<%= user.email %>">

    <br>
    <br>
    <label>Bio</label>
    <br>
    <textarea <%= user.bio %>></textarea>


</div>

<div class="favorite-setting">
<h1>Favorites</h1>
<br>
<h2> Songs</h2>
<div class="favorite-song-holder"> 

    <% for(var i = 0; i < user.favoriteSongs.length; i++) { %>
        
        <% if(user.favoriteSongs[i] === null) { %>
        
        <div id = <%= i %>; class="favorite-song-null" href = "/songs/9999" onclick="searcb(this.id)">
            
        </div> 
   <% } else {%>
    <a id = <%= i %> class="favorite-song" href = "/songs/9999">
        <img class = "song-img" src="https://i.scdn.co/image/ab67616d0000b27326f7f19c7f0381e56156c94a" alt="Lamp" width="200px">
        <p class = "vInfo" id = "overflo"> <span style ="font-size: 20px; ">Flashing Lights</span><br> <span style="font-size: 12.5px; color:rgb(170, 170, 170)">Tyler, The Creator</span></p>
  </a> 
    <% } %>
   
        
        <% } %>





</div>
</div>
<input id ="myHidden" type="hidden" name = "songs"; value="">

<button type="submit">Save</button>
</form>

<div id="pop-up">

    

    <div id="sub-div">
        <div class="search-holder">
    <input id="enter-link" type ="text" name="name" placeholder="Search song from Spotify" onkeyup="sendRequest(this.value)" style="border-radius: 17.5px; border: none; font-size: 20px; background-color:rgb(31, 31, 31); height: 40px; caret-color: white; color: white; padding-left: 10px;" size="50" >
    <a href ="/videos">Cancel</a>
    <button onclick="chooseVideo(document.getElementById('enter-link').value)">Create</button>
    
    </div>
    <div id = "results-div">
    
    </div>
    
    </div>
    
</div>